<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MediaTracked</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="MediaTracked">
  <meta name="description" content="Track books, audiobooks, movies, TV shows, and games privately and offline with MediaTracked.">
  <link rel="manifest" href="/Media-Tracked/manifest.json">
  <link rel="apple-touch-icon" href="/Media-Tracked/icon.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://accounts.google.com/gsi/client"></script>
</head>
<body class="min-h-screen bg-gray-200 font-sans antialiased">
  <div class="max-w-3xl mx-auto p-6">
    <header class="text-center mb-10">
      <h1 class="text-4xl font-extrabold text-gray-900 animate-fade-in">MediaTracked</h1>
      <p class="text-lg text-gray-600 mt-3 animate-fade-in-delayed">Track your books, audiobooks, movies, TV shows, and games—privately and offline.</p>
    </header>

    <section id="cloud-sync-settings" class="bg-green-50 p-4 rounded-lg mb-10 text-center animate-fade-in">
      <p class="text-gray-800 mb-2">
        <label class="flex items-center justify-center gap-2">
          <input id="cloud-sync-enabled" type="checkbox" onchange="toggleCloudSync()" />
          Enable Cloud Sync (requires Google login)
        </label>
      </p>
      <p class="text-sm text-gray-600 mb-2">
        Note: When cloud sync is enabled, your data is stored unencrypted in our database to sync across devices.
      </p>
      <div id="google-signin-section" class="mt-2 hidden">
        <div id="google-signin-button" class="g_id_signin" data-type="standard" data-size="medium" data-theme="outline" data-text="sign_in_with" data-shape="rectangular" data-logo_alignment="left"></div>
        <p id="google-user-email" class="text-sm text-gray-600 mt-2 hidden"></p>
        <button id="google-signout-button" onclick="signOut()" class="text-red-500 hover:underline font-semibold mt-2 hidden">Sign Out</button>
      </div>
      <p id="sync-status" class="text-sm text-gray-600 mt-2"></p>
    </section>

    <section class="bg-white p-6 rounded-lg shadow-md mb-10 transition-transform duration-300 hover:scale-[1.02]">
      <h2 class="text-2xl font-semibold text-gray-900 mb-4">Add New Media</h2>
      <div class="flex flex-col gap-4">
        <div class="relative">
          <input
            id="title"
            type="text"
            placeholder="Enter title (e.g., a book or movie)"
            aria-label="Media title"
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition-colors duration-200"
            oninput="fetchAutocomplete()"
          />
          <div id="autocomplete-loading" class="absolute right-3 top-3 hidden">
            <i class="fas fa-spinner fa-spin text-gray-400"></i>
          </div>
          <ul id="autocomplete-list" class="absolute z-20 w-full bg-white border border-gray-300 rounded-lg mt-1 max-h-48 overflow-y-auto hidden shadow-lg" role="listbox"></ul>
        </div>
        <select id="type" onchange="updateStatusOptions()" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" aria-label="Media type">
          <option value="Book">Book</option>
          <option value="Audiobook">Audiobook</option>
          <option value="TV Show">TV Show</option>
          <option value="Movie">Movie</option>
          <option value="Game">Game</option>
        </select>
        <select id="status" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" aria-label="Media status">
          <option value="To Read">To Read</option>
          <option value="Reading">Reading</option>
          <option value="Read">Read</option>
        </select>
        <button
          onclick="addMedia()"
          class="bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 transition-colors duration-200 text-lg"
        >
          Add Media
        </button>
      </div>
    </section>

    <section class="mb-10">
      <h2 class="text-2xl font-semibold text-gray-900 mb-4">Filter</h2>
      <select
        id="filter"
        onchange="renderMedia()"
        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
        aria-label="Filter media"
      >
        <option value="All">All</option>
        <option value="Books">Books</option>
        <option value="Audiobooks">Audiobooks</option>
        <option value="TV Shows">TV Shows</option>
        <option value="Movies">Movies</option>
        <option value="Games">Games</option>
        <option value="To Read">To Read</option>
        <option value="Reading">Reading</option>
        <option value="Read">Read</option>
        <option value="To Listen">To Listen</option>
        <option value="Listening">Listening</option>
        <option value="Listened">Listened</option>
        <option value="To Watch">To Watch</option>
        <option value="Watching">Watching</option>
        <option value="Watched">Watched</option>
        <option value="To Play">To Play</option>
        <option value="Playing">Playing</option>
        <option value="Played">Played</option>
      </select>
    </section>

    <section class="bg-white p-6 rounded-lg shadow-md mb-10 transition-transform duration-300 hover:scale-[1.02]">
      <h2 class="text-2xl font-semibold text-gray-900 mb-4">Your Media</h2>
      <div id="media-list" class="space-y-6"></div>
    </section>

    <section id="suggestions" class="bg-white p-6 rounded-lg shadow-md mb-10 transition-transform duration-300 hover:scale-[1.02]">
      <h2 class="text-2xl font-semibold text-gray-900 mb-4">Suggestions for You</h2>
      <div id="suggestions-list" class="space-y-4"></div>
    </section>

    <section id="affiliate-links" class="bg-white p-6 rounded-lg shadow-md mb-10 transition-transform duration-300 hover:scale-[1.02]">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-semibold text-gray-900">Explore More</h2>
        <button onclick="toggleAffiliateLinks()" class="text-blue-500 hover:text-blue-600 text-sm" aria-label="Toggle affiliate links">
          <i id="affiliate-toggle-icon" class="fas fa-chevron-up"></i>
        </button>
      </div>
      <div id="affiliate-content" class="space-y-2">
        <p class="text-gray-600 text-sm">Discover your next favorite media (affiliate links):</p>
        <div id="affiliate-list" class="flex flex-col gap-2"></div>
      </div>
    </section>

    <footer class="text-center text-gray-600 mt-10">
      <p>© 2025 MediaTracked. All rights reserved.</p>
      <p><a href="/Media-Tracked/privacy.html" class="text-blue-500 hover:underline">Privacy Policy</a></p>
    </footer>
  </div>

  <script>
    let media = JSON.parse(localStorage.getItem('mediatracked_media')) || [];
    let isCloudSyncEnabled = localStorage.getItem('mediatracked_cloudSyncEnabled') === 'true';
    let userId = localStorage.getItem('mediatracked_userId') || generateUserId();
    let isAffiliateCollapsed = false;
    let googleAccessToken = null;
    let googleUserEmail = null;
    let dbUserId = null;

    const CLIENT_ID = '1099263612427-lg5p8n7ssb3ed7936on9u2qhu7rrtin9.apps.googleusercontent.com';
    const BACKEND_URL = 'https://mediatracked-backend.vercel.app';

    const statusOptions = {
      Book: ['To Read', 'Reading', 'Read'],
      Audiobook: ['To Listen', 'Listening', 'Listened'],
      'TV Show': ['To Watch', 'Watching', 'Watched'],
      Movie: ['To Watch', 'Watching', 'Watched'],
      Game: ['To Play', 'Playing', 'Played']
    };

    const affiliateLinks = {
      Book: [
        { text: 'Dune by Frank Herbert', url: 'https://bookshop.org/a/YOUR_BOOKSHOP_ID/9780441172719' },
        { text: 'Explore Books on Amazon', url: 'https://www.amazon.com/s?k=books&tag=YOUR_AMAZON_TAG' }
      ],
      Audiobook: [
        { text: 'Dune Audiobook', url: 'https://www.audible.com/pd/Dune-Audiobook/B002V1OF70?ref=YOUR_AFFILIATE_TAG' },
        { text: 'Browse Audible Audiobooks', url: 'https://www.amazon.com/Audible-Books-and-Originals/b?node=18145289011&tag=YOUR_AMAZON_TAG' }
      ],
      'TV Show': [
        { text: 'Watch Game of Thrones', url: 'https://www.amazon.com/Game-of-Thrones-Season-1/dp/B007HJ84ZK?tag=YOUR_AMAZON_TAG' },
        { text: 'Explore TV Shows on Amazon', url: 'https://www.amazon.com/s?k=tv+shows&tag=YOUR_AMAZON_TAG' }
      ],
      Movie: [
        { text: 'Dune (2021) Movie', url: 'https://www.amazon.com/Dune-Timothee-Chalamet/dp/B09M7XJH2B?tag=YOUR_AMAZON_TAG' },
        { text: 'Browse Movies on Amazon', url: 'https://www.amazon.com/s?k=movies&tag=YOUR_AMAZON_TAG' }
      ],
      Game: [
        { text: 'Cyberpunk 2077', url: 'https://www.humblebundle.com/store/cyberpunk-2077?partner=YOUR_HUMBLE_ID' },
        { text: 'Explore Games on Amazon', url: 'https://www.amazon.com/s?k=video+games&tag=YOUR_AMAZON_TAG' }
      ]
    };

    let suggestionsCache = JSON.parse(localStorage.getItem('mediatracked_suggestions')) || {};

    function generateUserId() {
      const id = 'user_' + Math.random().toString(36).substr(2, 9);
      localStorage.setItem('mediatracked_userId', id);
      return id;
    }

    function generateDbUserId() {
      return Date.now();
    }

    function sanitizeInput(input) {
      const div = document.createElement('div');
      div.textContent = input;
      return div.innerHTML;
    }

    function initGoogleClient() {
      google.accounts.id.initialize({
        client_id: CLIENT_ID,
        callback: handleCredentialResponse
      });
      google.accounts.id.renderButton(
        document.getElementById('google-signin-button'),
        { theme: 'outline', size: 'medium' }
      );
    }

    async function handleCredentialResponse(response) {
      const profile = jwt_decode(response.credential);
      console.log('Profile from token:', profile);
      googleUserEmail = profile.email;
      googleAccessToken = response.credential;
      localStorage.setItem('mediatracked_googleUserEmail', googleUserEmail);
      localStorage.setItem('mediatracked_googleAccessToken', googleAccessToken);
      updateCloudSyncVisibility();
      document.getElementById('google-user-email').classList.remove('hidden');
      document.getElementById('google-user-email').textContent = `Signed in as: ${googleUserEmail}`;
      document.getElementById('google-signin-button').classList.add('hidden');
      document.getElementById('google-signout-button').classList.remove('hidden');

      updateUserInDatabase();
      if (isCloudSyncEnabled) {
        syncToCloud();
      }
    }

    function signOut() {
      google.accounts.id.revoke(googleUserEmail, () => {
        googleAccessToken = null;
        googleUserEmail = null;
        dbUserId = null;
        localStorage.removeItem('mediatracked_googleAccessToken');
        localStorage.removeItem('mediatracked_googleUserEmail');
        localStorage.removeItem('mediatracked_dbUserId');
        document.getElementById('google-user-email').classList.add('hidden');
        document.getElementById('google-signin-button').classList.remove('hidden');
        document.getElementById('google-signout-button').classList.add('hidden');
        document.getElementById('sync-status').textContent = 'Signed out from Google.';
        updateCloudSyncVisibility();
      });
    }

    function jwt_decode(token) {
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
      return JSON.parse(jsonPayload);
    }

    function calculateMediaTypes() {
      const types = {};
      media.forEach(item => {
        types[item.type] = (types[item.type] || 0) + 1;
      });
      return types;
    }

    function saveMedia() {
      localStorage.setItem('mediatracked_media', JSON.stringify(media));
      if (isCloudSyncEnabled && googleAccessToken) {
        syncToCloud();
      }
    }

    function saveSuggestions() {
      localStorage.setItem('mediatracked_suggestions', JSON.stringify(suggestionsCache));
      if (isCloudSyncEnabled && googleAccessToken) {
        syncToCloud();
      }
    }

    function updateStatusOptions() {
      const type = document.getElementById('type').value;
      const statusSelect = document.getElementById('status');
      statusSelect.innerHTML = statusOptions[type].map(status => `<option value="${status}">${status}</option>`).join('');
    }

    async function fetchAmazonData(keywords, searchIndex, operation = 'SearchItems') {
      try {
        const response = await fetch(`${BACKEND_URL}/api/amazon`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${googleAccessToken}`
          },
          body: JSON.stringify({ keywords, searchIndex, operation })
        });

        if (!response.ok) throw new Error('Network error');
        const data = await response.json();
        return data;
      } catch (error) {
        console.error('Amazon PA-API error:', error);
        return null;
      }
    }

    async function fetchAutocomplete() {
      const titleInput = sanitizeInput(document.getElementById('title').value.trim());
      const type = document.getElementById('type').value;
      const autocompleteList = document.getElementById('autocomplete-list');
      const loadingIndicator = document.getElementById('autocomplete-loading');

      if (titleInput.length < 3) {
        autocompleteList.innerHTML = '';
        autocompleteList.classList.add('hidden');
        loadingIndicator.classList.add('hidden');
        return;
      }

      loadingIndicator.classList.remove('hidden');
      autocompleteList.classList.add('hidden');

      const searchIndex = {
        Book: 'Books',
        Audiobook: 'Books',
        Movie: 'Movies',
        'TV Show': 'Movies',
        Game: 'VideoGames'
      }[type];

      const data = await fetchAmazonData(titleInput, searchIndex);
      let results = [];

      if (data && data.ItemsResult && data.ItemsResult.Items) {
        results = data.ItemsResult.Items.map(item => {
          const isAudiobook = type === 'Audiobook' && item.ItemInfo.Classifications.ProductGroup.DisplayValue.toLowerCase().includes('audiobook');
          if (type === 'Audiobook' && !isAudiobook) return null;
          return {
            title: item.ItemInfo.Title.DisplayValue,
            year: item.ItemInfo.ContentInfo?.PublicationDate?.DisplayValue?.split('-')[0] || ''
          };
        }).filter(item => item);
      } else {
        results = [{ title: navigator.onLine ? 'Error fetching data' : 'Offline? Enter manually', year: '' }];
      }

      loadingIndicator.classList.add('hidden');
      autocompleteList.innerHTML = results.length && results[0].title !== 'Error fetching data' && results[0].title !== 'Offline? Enter manually'
        ? results.map((item, index) => `
            <li
              class="p-3 hover:bg-gray-100 cursor-pointer text-gray-800"
              role="option"
              aria-selected="false"
              onclick="selectAutocomplete('${sanitizeInput(item.title).replace(/'/g, "\\'")}')"
              onkeydown="if(event.key === 'Enter') selectAutocomplete('${sanitizeInput(item.title).replace(/'/g, "\\'")}')"
              tabindex="0"
            >
              ${sanitizeInput(item.title)} (${item.year || 'N/A'})
            </li>
          `).join('')
        : `<li class="p-3 text-gray-500">${results[0]?.title || 'No results found. Enter manually.'}</li>`;
      autocompleteList.classList.remove('hidden');
    }

    function selectAutocomplete(title) {
      document.getElementById('title').value = title;
      document.getElementById('autocomplete-list').classList.add('hidden');
    }

    function addMedia(title, type, status) {
      if (!title) {
        title = sanitizeInput(document.getElementById('title').value.trim());
        type = document.getElementById('type').value;
        status = document.getElementById('status').value;
      }

      if (!title) {
        alert('Please enter a title.');
        return;
      }

      const newMedia = { id: Date.now(), title, type, status };
      media.push(newMedia);
      saveMedia();
      document.getElementById('title').value = '';
      document.getElementById('autocomplete-list').classList.add('hidden');
      renderMedia();
      fetchSuggestions();
    }

    function toggleStatus(id) {
      media = media.map(item => {
        if (item.id !== id) return item;
        const statuses = statusOptions[item.type];
        const currentIndex = statuses.indexOf(item.status);
        const nextIndex = (currentIndex + 1) % statuses.length;
        return { ...item, status: statuses[nextIndex] };
      });
      saveMedia();
      renderMedia();
    }

    function deleteMedia(id) {
      media = media.filter(item => item.id !== id);
      saveMedia();
      renderMedia();
      fetchSuggestions();
    }

    function updateCloudSyncVisibility() {
      const googleSignInSection = document.getElementById('google-signin-section');

      if (isCloudSyncEnabled) {
        googleSignInSection.classList.remove('hidden');

        googleAccessToken = localStorage.getItem('mediatracked_googleAccessToken');
        googleUserEmail = localStorage.getItem('mediatracked_googleUserEmail');
        dbUserId = localStorage.getItem('mediatracked_dbUserId');
        if (googleUserEmail) {
          document.getElementById('google-user-email').classList.remove('hidden');
          document.getElementById('google-user-email').textContent = `Signed in as: ${googleUserEmail}`;
          document.getElementById('google-signin-button').classList.add('hidden');
          document.getElementById('google-signout-button').classList.remove('hidden');
        }
      } else {
        googleSignInSection.classList.add('hidden');
      }
    }

    function toggleCloudSync() {
      isCloudSyncEnabled = document.getElementById('cloud-sync-enabled').checked;
      localStorage.setItem('mediatracked_cloudSyncEnabled', isCloudSyncEnabled);
      updateCloudSyncVisibility();
      if (isCloudSyncEnabled && googleAccessToken) {
        syncToCloud();
      }
    }

    async function syncToCloud() {
      if (!isCloudSyncEnabled || !googleAccessToken || !dbUserId) {
        const syncStatus = document.getElementById('sync-status');
        syncStatus.textContent = 'Sync disabled, not signed in, or user not registered.';
        return;
      }

      const syncStatus = document.getElementById('sync-status');
      syncStatus.textContent = 'Syncing to cloud...';

      try {
        const mediaTypes = calculateMediaTypes();

        const response = await fetch(`${BACKEND_URL}/api/sync`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${googleAccessToken}`
          },
          body: JSON.stringify({
            user_id: dbUserId,
            media: media,
            suggestions_cache: suggestionsCache,
            media_types: mediaTypes
          })
        });

        if (!response.ok) throw new Error('Failed to sync');
        syncStatus.textContent = 'Successfully synced to cloud!';
      } catch (error) {
        console.error('Cloud sync error:', error);
        syncStatus.textContent = 'Failed to sync to cloud. Check your connection and try again.';
      }
    }

    async function loadFromCloud() {
      if (!googleAccessToken || !dbUserId) {
        const syncStatus = document.getElementById('sync-status');
        syncStatus.textContent = 'Please sign in with Google to load data.';
        return;
      }

      const syncStatus = document.getElementById('sync-status');
      syncStatus.textContent = 'Loading from cloud...';

      try {
        const response = await fetch(`${BACKEND_URL}/api/load?user_id=${dbUserId}`, {
          headers: {
            'Authorization': `Bearer ${googleAccessToken}`
          }
        });
        if (!response.ok) throw new Error('Failed to load');
        const data = await response.json();

        if (data && Object.keys(data).length > 0) {
          media = data.media || [];
          suggestionsCache = data.suggestions_cache || {};
          localStorage.setItem('mediatracked_media', JSON.stringify(media));
          localStorage.setItem('mediatracked_suggestions', JSON.stringify(suggestionsCache));
          updateCloudSyncVisibility();
          syncStatus.textContent = 'Successfully loaded from cloud!';
          renderMedia();
          fetchSuggestions();
        } else {
          syncStatus.textContent = 'No cloud data found for this user.';
        }
      } catch (error) {
        console.error('Cloud load error:', error);
        syncStatus.textContent = 'Failed to load from cloud. Check your connection and try again.';
      }
    }

    function toggleAffiliateLinks() {
      isAffiliateCollapsed = !isAffiliateCollapsed;
      const content = document.getElementById('affiliate-content');
      const icon = document.getElementById('affiliate-toggle-icon');
      content.classList.toggle('hidden');
      icon.classList.toggle('fa-chevron-up');
      icon.classList.toggle('fa-chevron-down');
    }

    function generateAffiliateLink(title, type) {
      const searchTerm = encodeURIComponent(`${title} ${type.toLowerCase()}`);
      return `https://www.amazon.com/s?k=${searchTerm}&tag=your-affiliate-tag`;
    }

    async function fetchSuggestions() {
      const suggestionsList = document.getElementById('suggestions-list');
      suggestionsList.innerHTML = '<p class="text-gray-500 text-center py-4">Loading suggestions...</p>';

      const recentMedia = media.slice(-3);
      let suggestions = [];

      for (const item of recentMedia) {
        const cacheKey = `${item.type}-${item.title}`;
        if (suggestionsCache[cacheKey]) {
          suggestions = suggestions.concat(suggestionsCache[cacheKey]);
          continue;
        }

        let relatedItems = [];
        const searchIndex = {
          Book: 'Books',
          Audiobook: 'Books',
          Movie: 'Movies',
          'TV Show': 'Movies',
          Game: 'VideoGames'
        }[type];

        const searchData = await fetchAmazonData(item.title, searchIndex);
        if (!searchData || !searchData.ItemsResult || !searchData.ItemsResult.Items) {
          continue;
        }

        const foundItem = searchData.ItemsResult.Items[0];
        if (!foundItem) continue;

        if (item.type === 'Book' || item.type === 'Audiobook') {
          const author = foundItem.ItemInfo.ByLineInfo?.Contributors?.find(c => c.Role === 'Author')?.Name;
          if (author) {
            const authorData = await fetchAmazonData(`inauthor:${author}`, 'Books');
            if (authorData && authorData.ItemsResult && authorData.ItemsResult.Items) {
              relatedItems = authorData.ItemsResult.Items
                .filter(d => d.ItemInfo.Title.DisplayValue !== item.title)
                .map(d => {
                  const isAudiobook = d.ItemInfo.Classifications.ProductGroup.DisplayValue.toLowerCase().includes('audiobook');
                  if (item.type === 'Audiobook' && !isAudiobook) return null;
                  if (item.type === 'Book' && isAudiobook) return null;
                  return {
                    title: d.ItemInfo.Title.DisplayValue,
                    type: item.type,
                    status: statusOptions[item.type][0],
                    source: `Based on ${item.title} by ${author}`
                  };
                })
                .filter(d => d);
            }
          }
        } else {
          const genre = foundItem.ItemInfo.Classifications?.Genre?.DisplayValue || '';
          if (genre) {
            const genreData = await fetchAmazonData(genre, searchIndex);
            if (genreData && genreData.ItemsResult && genreData.ItemsResult.Items) {
              relatedItems = genreData.ItemsResult.Items
                .filter(d => d.ItemInfo.Title.DisplayValue !== item.title)
                .map(d => ({
                  title: d.ItemInfo.Title.DisplayValue,
                  type: item.type,
                  status: statusOptions[item.type][0],
                  source: `Similar to ${item.title}`
                }));
            }
          }
        }

        if (relatedItems.length > 0) {
          suggestionsCache[cacheKey] = relatedItems;
          suggestions = suggestions.concat(relatedItems);
        }
      }

      saveSuggestions();

      const seenTitles = new Set();
      suggestions = suggestions.filter(item => {
        if (seenTitles.has(item.title)) return false;
        seenTitles.add(item.title);
        return true;
      });

      suggestions = suggestions.slice(0, 5);

      suggestionsList.innerHTML = suggestions.length === 0
        ? '<p class="text-gray-500 text-center py-4">No suggestions yet. Add more media to get recommendations!</p>'
        : suggestions.map(item => `
            <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200">
              <div>
                <h4 class="font-medium text-gray-900 text-lg">${sanitizeInput(item.title)}</h4>
                <p class="text-sm text-gray-600">${item.type} | ${item.source}</p>
              </div>
              <div class="flex gap-4">
                <button
                  onclick="addMedia('${sanitizeInput(item.title).replace(/'/g, "\\'")}', '${item.type}', '${item.status}')"
                  class="text-blue-500 hover:text-blue-600 transition-colors duration-200 text-sm font-medium"
                >
                  Add to List
                </button>
                <a
                  href="${generateAffiliateLink(item.title, item.type)}"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="text-green-500 hover:text-green-600 transition-colors duration-200 text-sm font-medium"
                >
                  Buy Now
                </a>
              </div>
            </div>
          `).join('');
    }

    async function updateUserInDatabase() {
      let retries = 3;
      dbUserId = generateDbUserId();
      console.log('googleAccessToken:', googleAccessToken);
      console.log('Request body:', { id: dbUserId, user_id: userId, email: googleUserEmail });
      while (retries > 0) {
        try {
          const response = await fetch(`${BACKEND_URL}/api/users`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${googleAccessToken}`
            },
            body: JSON.stringify({
              id: dbUserId,
              user_id: userId,
              email: googleUserEmail
            })
          });

          if (!response.ok) {
            const errorBody = await response.json();
            throw new Error(`Failed to update user: ${response.status} ${JSON.stringify(errorBody)}`);
          }
          localStorage.setItem('mediatracked_dbUserId', dbUserId);
          return;
        } catch (error) {
          console.error('User update error:', error);
          retries--;
          if (retries === 0) {
            document.getElementById('sync-status').textContent = 'Failed to update user in database. Please try again.';
            return;
          }
          await new Promise(resolve => setTimeout(resolve, 1000));
        }
      }
    }

    function renderMedia() {
      const filter = document.getElementById('filter').value;
      const mediaList = document.getElementById('media-list');
      const affiliateList = document.getElementById('affiliate-list');

      const filteredMedia = media.filter(item => {
        if (filter === 'All') return true;
        if (filter === 'Books') return item.type === 'Book';
        if (filter === 'Audiobooks') return item.type === 'Audiobook';
        if (filter === 'TV Shows') return item.type === 'TV Show';
        if (filter === 'Movies') return item.type === 'Movie';
        if (filter === 'Games') return item.type === 'Game';
        return item.status === filter;
      });

      const typeIcons = {
        Book: 'fa-book',
        Audiobook: 'fa-headphones',
        'TV Show': 'fa-tv',
        Movie: 'fa-film',
        Game: 'fa-gamepad'
      };

      const groupedMedia = {};
      filteredMedia.forEach(item => {
        if (!groupedMedia[item.type]) {
          groupedMedia[item.type] = [];
        }
        groupedMedia[item.type].push(item);
      });

      let html = '';
      const mediaTypes = ['Book', 'Audiobook', 'TV Show', 'Movie', 'Game'];
      mediaTypes.forEach(type => {
        if (groupedMedia[type] && groupedMedia[type].length > 0) {
          html += `
            <div class="mb-4">
              <h3 class="text-xl font-semibold text-gray-800 mb-2">${type}s</h3>
              <div class="space-y-4">
                ${groupedMedia[type].map(item => `
                  <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200">
                    <div class="flex items-center gap-4">
                      <i class="fas ${typeIcons[item.type]} text-blue-500 text-xl"></i>
                      <div>
                        <h4 class="font-medium text-gray-900 text-lg">${sanitizeInput(item.title)}</h4>
                        <p class="text-sm text-gray-600">${item.status}</p>
                      </div>
                    </div>
                    <div class="flex gap-4">
                      <button
                        onclick="toggleStatus(${item.id})"
                        class="text-blue-500 hover:text-blue-600 transition-colors duration-200 text-sm font-medium"
                        aria-label="Toggle status for ${sanitizeInput(item.title)}"
                      >
                        Next Status
                      </button>
                      <button
                        onclick="deleteMedia(${item.id})"
                        class="text-red-500 hover:text-red-600 transition-colors duration-200"
                        aria-label="Delete ${sanitizeInput(item.title)}"
                      >
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        }
      });

      mediaList.innerHTML = html || '<p class="text-gray-500 text-center py-4">Your media list is empty. Add media to start!</p>';

      const filterType = filter === 'All' || statusOptions[filter] ? (media[media.length - 1]?.type || 'Book') : filter.replace('s', '');
      const links = affiliateLinks[filterType] || affiliateLinks.Book;
      affiliateList.innerHTML = links.map(link => `
        <a href="${link.url}" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:underline text-sm">${sanitizeInput(link.text)}</a>
      `).join('');

      fetchSuggestions();
    }

    updateStatusOptions();
    updateCloudSyncVisibility();
    initGoogleClient();
    if (isCloudSyncEnabled && googleAccessToken) {
      loadFromCloud();
    }
    renderMedia();
    fetchSuggestions();

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/Media-Tracked/sw.js', { scope: '/Media-Tracked/' }).catch(error => {
          console.error('Service Worker registration failed:', error);
        });
      });
    }

    tailwind.config = {
      theme: {
        extend: {
          animation: {
            'fade-in': 'fadeIn 0.5s ease-out',
            'fade-in-delayed': 'fadeIn 0.5s ease-out 0.2s'
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0', transform: 'translateY(10px)' },
              '100%': { opacity: '1', transform: 'translateY(0)' }
            }
          }
        }
      }
    };
  </script>
</body>
</html>
