<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MediaTracked</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="MediaTracked">
  <meta name="description" content="Track books, audiobooks, movies, TV shows, and games privately and offline with MediaTracked.">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icon.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gray-200 font-sans antialiased">
  <div class="max-w-3xl mx-auto p-6">
    <header class="text-center mb-10">
      <h1 class="text-4xl font-extrabold text-gray-900 animate-fade-in">MediaTracked</h1>
      <p class="text-lg text-gray-600 mt-3 animate-fade-in-delayed">Track your books, audiobooks, movies, TV shows, and gamesâ€”privately and offline.</p>
    </header>

    <!-- Ad and Affiliate Settings -->
    <section id="ad-settings" class="bg-blue-50 p-4 rounded-lg mb-10 text-center animate-fade-in">
      <p class="text-gray-800 mb-2">Love MediaTracked? <button onclick="showAdRemoval()" class="text-blue-500 hover:underline font-semibold">Remove Ads & Links for $5</button></p>
      <p id="enter-code-section" class="text-gray-800 mb-2 hidden">
        Already paid? Enter your code: 
        <input id="ad-removal-code" type="text" placeholder="e.g., ADFREE-XYZ123" class="p-1 border border-gray-300 rounded-md mx-2" />
        <button onclick="applyAdRemovalCode()" class="text-blue-500 hover:underline font-semibold">Apply</button>
      </p>
      <p id="ad-removal-message" class="text-gray-800 mb-2 hidden"></p>
      <p class="text-sm text-gray-600">Ads and affiliate links keep us running! <a href="https://forms.gle/YOUR_FEEDBACK_FORM" target="_blank" class="text-blue-500 hover:underline">Share feedback</a></p>
    </section>

    <!-- Add Media Form -->
    <section class="bg-white p-6 rounded-lg shadow-md mb-10 transition-transform duration-300 hover:scale-[1.02]">
      <h2 class="text-2xl font-semibold text-gray-900 mb-4">Add New Media</h2>
      <div class="flex flex-col gap-4">
        <div class="relative">
          <input
            id="title"
            type="text"
            placeholder="Enter title (e.g., a book or movie)"
            aria-label="Media title"
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition-colors duration-200"
            oninput="fetchAutocomplete()"
          />
          <div id="autocomplete-loading" class="absolute right-3 top-3 hidden">
            <i class="fas fa-spinner fa-spin text-gray-400"></i>
          </div>
          <ul id="autocomplete-list" class="absolute z-20 w-full bg-white border border-gray-300 rounded-lg mt-1 max-h-48 overflow-y-auto hidden shadow-lg" role="listbox"></ul>
        </div>
        <select id="type" onchange="updateStatusOptions()" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" aria-label="Media type">
          <option value="Book">Book</option>
          <option value="Audiobook">Audiobook</option>
          <option value="TV Show">TV Show</option>
          <option value="Movie">Movie</option>
          <option value="Game">Game</option>
        </select>
        <select id="status" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" aria-label="Media status">
          <option value="To Read">To Read</option>
          <option value="Reading">Reading</option>
          <option value="Read">Read</option>
        </select>
        <button
          onclick="addMedia()"
          class="bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 transition-colors duration-200 text-lg"
        >
          Add Media
        </button>
      </div>
    </section>

    <!-- Filter Options -->
    <section class="mb-10">
      <h2 class="text-2xl font-semibold text-gray-900 mb-4">Filter</h2>
      <select
        id="filter"
        onchange="renderMedia()"
        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
        aria-label="Filter media"
      >
        <option value="All">All</option>
        <option value="Books">Books</option>
        <option value="Audiobooks">Audiobooks</option>
        <option value="TV Shows">TV Shows</option>
        <option value="Movies">Movies</option>
        <option value="Games">Games</option>
        <option value="To Read">To Read</option>
        <option value="Reading">Reading</option>
        <option value="Read">Read</option>
        <option value="To Listen">To Listen</option>
        <option value="Listening">Listening</option>
        <option value="Listened">Listened</option>
        <option value="To Watch">To Watch</option>
        <option value="Watching">Watching</option>
        <option value="Watched">Watched</option>
        <option value="To Play">To Play</option>
        <option value="Playing">Playing</option>
        <option value="Played">Played</option>
      </select>
    </section>

    <!-- Media List -->
    <section class="bg-white p-6 rounded-lg shadow-md mb-10 transition-transform duration-300 hover:scale-[1.02]">
      <h2 class="text-2xl font-semibold text-gray-900 mb-4">Your Media</h2>
      <div id="media-list" class="space-y-6"></div>
    </section>

    <!-- Suggestions Section -->
    <section id="suggestions" class="bg-white p-6 rounded-lg shadow-md mb-10 transition-transform duration-300 hover:scale-[1.02]">
      <h2 class="text-2xl font-semibold text-gray-900 mb-4">Suggestions for You</h2>
      <div id="suggestions-list" class="space-y-4"></div>
    </section>

    <!-- Affiliate Links -->
    <section id="affiliate-links" class="bg-white p-6 rounded-lg shadow-md mb-10 transition-transform duration-300 hover:scale-[1.02]">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-semibold text-gray-900">Explore More</h2>
        <button onclick="toggleAffiliateLinks()" class="text-blue-500 hover:text-blue-600 text-sm" aria-label="Toggle affiliate links">
          <i id="affiliate-toggle-icon" class="fas fa-chevron-up"></i>
        </button>
      </div>
      <div id="affiliate-content" class="space-y-2">
        <p class="text-gray-600 text-sm">Discover your next favorite media:</p>
        <div id="affiliate-list" class="flex flex-col gap-2"></div>
      </div>
    </section>

    <!-- Ad Banner -->
    <section id="ad-banner" class="text-center mb-10">
      <ins class="adsbygoogle"
           style="display:block"
           data-ad-client="ca-pub-0000000000000000"
           data-ad-slot="1234567890"
           data-ad-format="auto"
           data-full-width-responsive="true"></ins>
      <div id="ad-placeholder" class="hidden bg-gray-200 p-2 rounded-lg text-gray-600 text-sm">
        Ad loading... (Media-related ads, e.g., books, games)
      </div>
      <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-0000000000000000" crossorigin="anonymous"></script>
      <script>
        document.addEventListener('DOMContentLoaded', () => {
          try {
            (adsbygoogle = window.adsbygoogle || []).push({});
          } catch (e) {
            document.getElementById('ad-banner').innerHTML = '<p class="text-gray-500 text-sm">Ad failed to load. Please check your connection.</p>';
          }
        });
      </script>
    </section>
  </div>

  <script>
    let media = JSON.parse(localStorage.getItem('mediatracked_media')) || [];
    let adRemovalCode = localStorage.getItem('mediatracked_adRemovalCode') || null;
    let isAdFree = adRemovalCode !== null;
    let isAffiliateCollapsed = false;
    const statusOptions = {
      Book: ['To Read', 'Reading', 'Read'],
      Audiobook: ['To Listen', 'Listening', 'Listened'],
      'TV Show': ['To Watch', 'Watching', 'Watched'],
      Movie: ['To Watch', 'Watching', 'Watched'],
      Game: ['To Play', 'Playing', 'Played']
    };

    // Affiliate Links for "Explore More" section (placeholders)
    const affiliateLinks = {
      Book: [
        { text: 'Dune by Frank Herbert', url: 'https://bookshop.org/a/YOUR_BOOKSHOP_ID/9780441172719' },
        { text: 'Explore Books on Amazon', url: 'https://www.amazon.com/s?k=books&tag=YOUR_AMAZON_TAG' }
      ],
      Audiobook: [
        { text: 'Dune Audiobook', url: 'https://www.audible.com/pd/Dune-Audiobook/B002V1OF70?ref=YOUR_AFFILIATE_TAG' },
        { text: 'Browse Audible Audiobooks', url: 'https://www.amazon.com/Audible-Books-and-Originals/b?node=18145289011&tag=YOUR_AMAZON_TAG' }
      ],
      'TV Show': [
        { text: 'Watch Game of Thrones', url: 'https://www.amazon.com/Game-of-Thrones-Season-1/dp/B007HJ84ZK?tag=YOUR_AMAZON_TAG' },
        { text: 'Explore TV Shows on Amazon', url: 'https://www.amazon.com/s?k=tv+shows&tag=YOUR_AMAZON_TAG' }
      ],
      Movie: [
        { text: 'Dune (2021) Movie', url: 'https://www.amazon.com/Dune-Timothee-Chalamet/dp/B09M7XJH2B?tag=YOUR_AMAZON_TAG' },
        { text: 'Browse Movies on Amazon', url: 'https://www.amazon.com/s?k=movies&tag=YOUR_AMAZON_TAG' }
      ],
      Game: [
        { text: 'Cyberpunk 2077', url: 'https://www.humblebundle.com/store/cyberpunk-2077?partner=YOUR_HUMBLE_ID' },
        { text: 'Explore Games on Amazon', url: 'https://www.amazon.com/s?k=video+games&tag=YOUR_AMAZON_TAG' }
      ]
    };

    const AMAZON_AFFILIATE_TAG = 'YOUR_AMAZON_TAG'; // Replace with your Amazon Associates tag (e.g., 'yourtag-20')

    // Cache for suggestions to avoid repeated queries
    let suggestionsCache = JSON.parse(localStorage.getItem('mediatracked_suggestions')) || {};

    function sanitizeInput(input) {
      const div = document.createElement('div');
      div.textContent = input;
      return div.innerHTML;
    }

    function saveMedia() {
      localStorage.setItem('mediatracked_media', JSON.stringify(media));
    }

    function saveSuggestions() {
      localStorage.setItem('mediatracked_suggestions', JSON.stringify(suggestionsCache));
    }

    function generateAdRemovalCode() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let code = 'ADFREE-';
      for (let i = 0; i < 6; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return code;
    }

    function showAdRemoval() {
      const code = generateAdRemovalCode();
      adRemovalCode = code;
      localStorage.setItem('mediatracked_adRemovalCode', code);
      isAdFree = true;
      updateAdVisibility();
      const message = document.getElementById('ad-removal-message');
      message.classList.remove('hidden');
      message.innerHTML = `Ads and affiliate links removed! Your code is: <strong>${code}</strong>. Save this code to use on other browsers or devices.`;
      alert('Ads and affiliate links removed! (Simulated $5 purchase. Add Stripe: https://stripe.com/docs/payments)');
    }

    function applyAdRemovalCode() {
      const inputCode = document.getElementById('ad-removal-code').value.trim();
      const message = document.getElementById('ad-removal-message');
      if (inputCode === adRemovalCode) {
        isAdFree = true;
        localStorage.setItem('mediatracked_adRemovalCode', inputCode);
        updateAdVisibility();
        message.classList.remove('hidden');
        message.innerHTML = 'Code applied! Ads and affiliate links removed.';
      } else {
        message.classList.remove('hidden');
        message.innerHTML = 'Invalid code. Please try again or purchase ad removal.';
      }
    }

    function updateStatusOptions() {
      const type = document.getElementById('type').value;
      const statusSelect = document.getElementById('status');
      statusSelect.innerHTML = statusOptions[type].map(status => `<option value="${status}">${status}</option>`).join('');
    }

    async function fetchAutocomplete() {
      const titleInput = sanitizeInput(document.getElementById('title').value.trim());
      const type = document.getElementById('type').value;
      const autocompleteList = document.getElementById('autocomplete-list');
      const loadingIndicator = document.getElementById('autocomplete-loading');

      if (titleInput.length < 3) {
        autocompleteList.innerHTML = '';
        autocompleteList.classList.add('hidden');
        loadingIndicator.classList.add('hidden');
        return;
      }

      loadingIndicator.classList.remove('hidden');
      autocompleteList.classList.add('hidden');

      let results = [];

      // Use Google Books for Books and Audiobooks
      if (type === 'Book' || type === 'Audiobook') {
        try {
          const url = type === 'Book'
            ? `https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(titleInput)}&maxResults=5`
            : `https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(titleInput)}+inaudiobook&maxResults=5`;
          const response = await fetch(url);
          if (!response.ok) throw new Error('Network error');
          const data = await response.json();
          results = data.items.map(item => ({
            title: item.volumeInfo.title,
            year: item.volumeInfo.publishedDate?.split('-')[0] || ''
          }));
        } catch (error) {
          console.error('Google Books error:', error);
          results = [{ title: navigator.onLine ? 'Error fetching data' : 'Offline? Enter manually', year: '' }];
        }
      } else {
        // Use Wikidata for Movies, TV Shows, and Games
        try {
          let sparqlQuery;
          if (type === 'Book') {
            sparqlQuery = `
              SELECT ?book ?bookLabel ?publicationDate WHERE {
                ?book wdt:P31 wd:Q571.
                ?book rdfs:label ?bookLabel.
                FILTER(LANG(?bookLabel) = "en")
                FILTER(CONTAINS(LCASE(?bookLabel), "${titleInput.toLowerCase()}"))
                OPTIONAL { ?book wdt:P577 ?publicationDate. }
              }
              LIMIT 5
            `;
          } else if (type === 'Movie') {
            sparqlQuery = `
              SELECT ?movie ?movieLabel ?releaseDate WHERE {
                ?movie wdt:P31 wd:Q11424.
                ?movie rdfs:label ?movieLabel.
                FILTER(LANG(?movieLabel) = "en")
                FILTER(CONTAINS(LCASE(?movieLabel), "${titleInput.toLowerCase()}"))
                OPTIONAL { ?movie wdt:P577 ?releaseDate. }
              }
              LIMIT 5
            `;
          } else if (type === 'TV Show') {
            sparqlQuery = `
              SELECT ?tvShow ?tvShowLabel ?releaseDate WHERE {
                ?tvShow wdt:P31 wd:Q5398426.
                ?tvShow rdfs:label ?tvShowLabel.
                FILTER(LANG(?tvShowLabel) = "en")
                FILTER(CONTAINS(LCASE(?tvShowLabel), "${titleInput.toLowerCase()}"))
                OPTIONAL { ?tvShow wdt:P577 ?releaseDate. }
              }
              LIMIT 5
            `;
          } else if (type === 'Game') {
            sparqlQuery = `
              SELECT ?game ?gameLabel ?releaseDate WHERE {
                ?game wdt:P31 wd:Q7889.
                ?game rdfs:label ?gameLabel.
                FILTER(LANG(?gameLabel) = "en")
                FILTER(CONTAINS(LCASE(?gameLabel), "${titleInput.toLowerCase()}"))
                OPTIONAL { ?game wdt:P577 ?releaseDate. }
              }
              LIMIT 5
            `;
          }

          if (sparqlQuery) {
            const response = await fetch('https://query.wikidata.org/sparql?query=' + encodeURIComponent(sparqlQuery), {
              headers: { 'Accept': 'application/sparql-results+json' }
            });
            if (!response.ok) throw new Error('Network error');
            const data = await response.json();
            results = data.results.bindings.map(item => ({
              title: item[type === 'Game' ? 'gameLabel' : type === 'TV Show' ? 'tvShowLabel' : type === 'Movie' ? 'movieLabel' : 'bookLabel'].value,
              year: item.releaseDate ? item.releaseDate.value.split('-')[0] : (item.publicationDate ? item.publicationDate.value.split('-')[0] : '')
            }));
          }
        } catch (error) {
          console.error('Wikidata error:', error);
          results = [{ title: navigator.onLine ? 'Error fetching data' : 'Offline? Enter manually', year: '' }];
        }
      }

      loadingIndicator.classList.add('hidden');
      autocompleteList.innerHTML = results.length && results[0].title !== 'Error fetching data' && results[0].title !== 'Offline? Enter manually'
        ? results.map((item, index) => `
            <li
              class="p-3 hover:bg-gray-100 cursor-pointer text-gray-800"
              role="option"
              aria-selected="false"
              onclick="selectAutocomplete('${sanitizeInput(item.title).replace(/'/g, "\\'")}')"
              onkeydown="if(event.key === 'Enter') selectAutocomplete('${sanitizeInput(item.title).replace(/'/g, "\\'")}')"
              tabindex="0"
            >
              ${sanitizeInput(item.title)} (${item.year || 'N/A'})
            </li>
          `).join('')
        : `<li class="p-3 text-gray-500">${results[0]?.title || 'No results found. Enter manually.'}</li>`;
      autocompleteList.classList.remove('hidden');
    }

    function selectAutocomplete(title) {
      document.getElementById('title').value = title;
      document.getElementById('autocomplete-list').classList.add('hidden');
    }

    function addMedia(title, type, status) {
      if (!title) {
        title = sanitizeInput(document.getElementById('title').value.trim());
        type = document.getElementById('type').value;
        status = document.getElementById('status').value;
      }

      if (!title) {
        alert('Please enter a title.');
        return;
      }

      const newMedia = { id: Date.now(), title, type, status };
      media.push(newMedia);
      saveMedia();
      document.getElementById('title').value = '';
      document.getElementById('autocomplete-list').classList.add('hidden');
      renderMedia();
      fetchSuggestions();
    }

    function toggleStatus(id) {
      media = media.map(item => {
        if (item.id !== id) return item;
        const statuses = statusOptions[item.type];
        const currentIndex = statuses.indexOf(item.status);
        const nextIndex = (currentIndex + 1) % statuses.length;
        return { ...item, status: statuses[nextIndex] };
      });
      saveMedia();
      renderMedia();
    }

    function deleteMedia(id) {
      media = media.filter(item => item.id !== id);
      saveMedia();
      renderMedia();
      fetchSuggestions();
    }

    function updateAdVisibility() {
      const adBanner = document.getElementById('ad-banner');
      const adSettings = document.getElementById('ad-settings');
      const affiliateLinks = document.getElementById('affiliate-links');
      const suggestionsSection = document.getElementById('suggestions');
      const adPlaceholder = document.getElementById('ad-placeholder');
      const enterCodeSection = document.getElementById('enter-code-section');

      if (isAdFree) {
        adBanner.style.display = 'none';
        adSettings.style.display = 'none';
        affiliateLinks.style.display = 'none';
        suggestionsSection.style.display = 'none';
        enterCodeSection.classList.add('hidden');
      } else {
        adBanner.style.display = 'block';
        adSettings.style.display = 'block';
        affiliateLinks.style.display = 'block';
        suggestionsSection.style.display = 'block';
        adPlaceholder.classList.remove('hidden');
        setTimeout(() => adPlaceholder.classList.add('hidden'), 3000);
        enterCodeSection.classList.remove('hidden');
      }
    }

    function toggleAffiliateLinks() {
      isAffiliateCollapsed = !isAffiliateCollapsed;
      const content = document.getElementById('affiliate-content');
      const icon = document.getElementById('affiliate-toggle-icon');
      content.classList.toggle('hidden');
      icon.classList.toggle('fa-chevron-up');
      icon.classList.toggle('fa-chevron-down');
    }

    function generateAffiliateLink(title, type) {
      const searchTerm = encodeURIComponent(`${title} ${type.toLowerCase()}`);
      return `https://www.amazon.com/s?k=${searchTerm}&tag=${AMAZON_AFFILIATE_TAG}`;
    }

    async function fetchSuggestions() {
      const suggestionsList = document.getElementById('suggestions-list');
      suggestionsList.innerHTML = '<p class="text-gray-500 text-center py-4">Loading suggestions...</p>';

      const recentMedia = media.slice(-3);
      let suggestions = [];

      for (const item of recentMedia) {
        const cacheKey = `${item.type}-${item.title}`;
        if (suggestionsCache[cacheKey]) {
          suggestions = suggestions.concat(suggestionsCache[cacheKey]);
          continue;
        }

        let relatedItems = [];

        // Use Google Books for Books and Audiobooks
        if (item.type === 'Book' || item.type === 'Audiobook') {
          try {
            const searchResponse = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(item.title)}&maxResults=1`);
            if (!searchResponse.ok) throw new Error('Network error');
            const searchData = await searchResponse.json();
            const book = searchData.items[0];
            if (book && book.volumeInfo.authors) {
              const author = book.volumeInfo.authors[0];
              const authorResponse = await fetch(`https://www.googleapis.com/books/v1/volumes?q=inauthor:${encodeURIComponent(author)}&maxResults=3`);
              if (!authorResponse.ok) throw new Error('Network error');
              const authorData = await authorResponse.json();
              relatedItems = authorData.items
                .filter(d => d.volumeInfo.title !== item.title)
                .map(d => ({
                  title: d.volumeInfo.title,
                  type: item.type,
                  status: statusOptions[item.type][0],
                  source: `Based on ${item.title} by ${author}`
                }));
            }
          } catch (error) {
            console.error('Suggestions error:', error);
            relatedItems = [];
          }
        } else {
          // Use Wikidata for Movies, TV Shows, and Games
          try {
            let sparqlQuery;
            if (item.type === 'Book') {
              sparqlQuery = `
                SELECT ?book ?bookLabel ?authorLabel WHERE {
                  ?book wdt:P31 wd:Q571.
                  ?book wdt:P50 ?author.
                  ?otherBook wdt:P31 wd:Q571.
                  ?otherBook wdt:P50 ?author.
                  ?otherBook rdfs:label ?bookLabel.
                  FILTER(LANG(?bookLabel) = "en")
                  ?book rdfs:label ?itemLabel.
                  FILTER(?itemLabel = "${item.title}"@en)
                  FILTER(?book != ?otherBook)
                  ?author rdfs:label ?authorLabel.
                  FILTER(LANG(?authorLabel) = "en")
                }
                LIMIT 3
              `;
            } else if (item.type === 'Movie') {
              sparqlQuery = `
                SELECT ?movie ?movieLabel ?releaseDate WHERE {
                  ?movie wdt:P31 wd:Q11424.
                  ?movie wdt:P136 ?genre.
                  ?otherMovie wdt:P31 wd:Q11424.
                  ?otherMovie wdt:P136 ?genre.
                  ?otherMovie rdfs:label ?movieLabel.
                  FILTER(LANG(?movieLabel) = "en")
                  ?movie rdfs:label ?itemLabel.
                  FILTER(?itemLabel = "${item.title}"@en)
                  FILTER(?movie != ?otherMovie)
                  OPTIONAL { ?otherMovie wdt:P577 ?releaseDate. }
                }
                LIMIT 3
              `;
            } else if (item.type === 'TV Show') {
              sparqlQuery = `
                SELECT ?tvShow ?tvShowLabel ?releaseDate WHERE {
                  ?tvShow wdt:P31 wd:Q5398426.
                  ?tvShow wdt:P136 ?genre.
                  ?otherShow wdt:P31 wd:Q5398426.
                  ?otherShow wdt:P136 ?genre.
                  ?otherShow rdfs:label ?tvShowLabel.
                  FILTER(LANG(?tvShowLabel) = "en")
                  ?tvShow rdfs:label ?itemLabel.
                  FILTER(?itemLabel = "${item.title}"@en)
                  FILTER(?tvShow != ?otherShow)
                  OPTIONAL { ?otherShow wdt:P577 ?releaseDate. }
                }
                LIMIT 3
              `;
            } else if (item.type === 'Game') {
              sparqlQuery = `
                SELECT ?game ?gameLabel ?releaseDate WHERE {
                  ?game wdt:P31 wd:Q7889.
                  ?game wdt:P136 ?genre.
                  ?otherGame wdt:P31 wd:Q7889.
                  ?otherGame wdt:P136 ?genre.
                  ?otherGame rdfs:label ?gameLabel.
                  FILTER(LANG(?gameLabel) = "en")
                  ?game rdfs:label ?itemLabel.
                  FILTER(?itemLabel = "${item.title}"@en)
                  FILTER(?game != ?otherGame)
                  OPTIONAL { ?otherGame wdt:P577 ?releaseDate. }
                }
                LIMIT 3
              `;
            }

            if (sparqlQuery) {
              const response = await fetch('https://query.wikidata.org/sparql?query=' + encodeURIComponent(sparqlQuery), {
                headers: { 'Accept': 'application/sparql-results+json' }
              });
              if (!response.ok) throw new Error('Network error');
              const data = await response.json();
              relatedItems = data.results.bindings.map(d => ({
                title: d[item.type === 'Game' ? 'gameLabel' : item.type === 'TV Show' ? 'tvShowLabel' : item.type === 'Movie' ? 'movieLabel' : 'bookLabel'].value,
                type: item.type,
                status: statusOptions[item.type][0],
                source: `Similar to ${item.title}`
              }));
            }
          } catch (error) {
            console.error('Suggestions error:', error);
            relatedItems = [];
          }
        }

        if (relatedItems.length > 0) {
          suggestionsCache[cacheKey] = relatedItems;
          suggestions = suggestions.concat(relatedItems);
        }
      }

      saveSuggestions();

      // Deduplicate suggestions by title
      const seenTitles = new Set();
      suggestions = suggestions.filter(item => {
        if (seenTitles.has(item.title)) return false;
        seenTitles.add(item.title);
        return true;
      });

      // Limit to 5 suggestions
      suggestions = suggestions.slice(0, 5);

      // Render suggestions with affiliate links
      suggestionsList.innerHTML = suggestions.length === 0
        ? '<p class="text-gray-500 text-center py-4">No suggestions yet. Add more media to get recommendations!</p>'
        : suggestions.map(item => `
            <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200">
              <div>
                <h4 class="font-medium text-gray-900 text-lg">${sanitizeInput(item.title)}</h4>
                <p class="text-sm text-gray-600">${item.type} | ${item.source}</p>
              </div>
              <div class="flex gap-4">
                <button
                  onclick="addMedia('${sanitizeInput(item.title).replace(/'/g, "\\'")}', '${item.type}', '${item.status}')"
                  class="text-blue-500 hover:text-blue-600 transition-colors duration-200 text-sm font-medium"
                >
                  Add to List
                </button>
                <a
                  href="${generateAffiliateLink(item.title, item.type)}"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="text-green-500 hover:text-green-600 transition-colors duration-200 text-sm font-medium"
                >
                  Buy Now
                </a>
              </div>
            </div>
          `).join('');
    }

    function renderMedia() {
      const filter = document.getElementById('filter').value;
      const mediaList = document.getElementById('media-list');
      const affiliateList = document.getElementById('affiliate-list');

      // Filter media based on the selected filter
      const filteredMedia = media.filter(item => {
        if (filter === 'All') return true;
        if (filter === 'Books') return item.type === 'Book';
        if (filter === 'Audiobooks') return item.type === 'Audiobook';
        if (filter === 'TV Shows') return item.type === 'TV Show';
        if (filter === 'Movies') return item.type === 'Movie';
        if (filter === 'Games') return item.type === 'Game';
        return item.status === filter;
      });

      const typeIcons = {
        Book: 'fa-book',
        Audiobook: 'fa-headphones',
        'TV Show': 'fa-tv',
        Movie: 'fa-film',
        Game: 'fa-gamepad'
      };

      // Group filtered media by type
      const groupedMedia = {};
      filteredMedia.forEach(item => {
        if (!groupedMedia[item.type]) {
          groupedMedia[item.type] = [];
        }
        groupedMedia[item.type].push(item);
      });

      // Render grouped media
      let html = '';
      const mediaTypes = ['Book', 'Audiobook', 'TV Show', 'Movie', 'Game'];
      mediaTypes.forEach(type => {
        if (groupedMedia[type] && groupedMedia[type].length > 0) {
          html += `
            <div class="mb-4">
              <h3 class="text-xl font-semibold text-gray-800 mb-2">${type}s</h3>
              <div class="space-y-4">
                ${groupedMedia[type].map(item => `
                  <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200">
                    <div class="flex items-center gap-4">
                      <i class="fas ${typeIcons[item.type]} text-blue-500 text-xl"></i>
                      <div>
                        <h4 class="font-medium text-gray-900 text-lg">${sanitizeInput(item.title)}</h4>
                        <p class="text-sm text-gray-600">${item.status}</p>
                      </div>
                    </div>
                    <div class="flex gap-4">
                      <button
                        onclick="toggleStatus(${item.id})"
                        class="text-blue-500 hover:text-blue-600 transition-colors duration-200 text-sm font-medium"
                        aria-label="Toggle status for ${sanitizeInput(item.title)}"
                      >
                        Next Status
                      </button>
                      <button
                        onclick="deleteMedia(${item.id})"
                        class="text-red-500 hover:text-red-600 transition-colors duration-200"
                        aria-label="Delete ${sanitizeInput(item.title)}"
                      >
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        }
      });

      mediaList.innerHTML = html || '<p class="text-gray-500 text-center py-4">Your media list is empty. Add media to start!</p>';

      // Update affiliate links based on filter
      const filterType = filter === 'All' || statusOptions[filter] ? (media[media.length - 1]?.type || 'Book') : filter.replace('s', '');
      const links = affiliateLinks[filterType] || affiliateLinks.Book;
      affiliateList.innerHTML = links.map(link => `
        <a href="${link.url}" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:underline text-sm">${sanitizeInput(link.text)}</a>
      `).join('');

      updateAdVisibility();
      fetchSuggestions();
    }

    // Initialize
    updateStatusOptions();
    renderMedia();
    fetchSuggestions();

    // Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js', { scope: '/' }).catch(error => {
          console.error('Service Worker registration failed:', error);
        });
      });
    }

    // Tailwind Config
    tailwind.config = {
      theme: {
        extend: {
          animation: {
            'fade-in': 'fadeIn 0.5s ease-out',
            'fade-in-delayed': 'fadeIn 0.5s ease-out 0.2s'
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0', transform: 'translateY(10px)' },
              '100%': { opacity: '1', transform: 'translateY(0)' }
            }
          }
        }
      }
    };
  </script>
</body>
</html>
