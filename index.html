<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MediaTracked</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="MediaTracked">
  <meta name="description" content="Track books, audiobooks, movies, TV shows, and games privately and offline with MediaTracked.">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icon.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gray-200 font-sans antialiased">
  <div class="max-w-3xl mx-auto p-6">
    <header class="text-center mb-10">
      <h1 class="text-4xl font-extrabold text-gray-900 animate-fade-in">MediaTracked</h1>
      <p class="text-lg text-gray-600 mt-3 animate-fade-in-delayed">Track your books, audiobooks, movies, TV shows, and gamesâ€”privately and offline.</p>
    </header>

    <!-- Ad and Affiliate Settings -->
    <section id="ad-settings" class="bg-blue-50 p-4 rounded-lg mb-10 text-center animate-fade-in">
      <p class="text-gray-800 mb-2">Love MediaTracked? <button onclick="removeAds()" class="text-blue-500 hover:underline font-semibold">Remove Ads & Links for $5</button></p>
      <p class="text-sm text-gray-600">Ads and affiliate links keep us running! <a href="https://forms.gle/YOUR_FEEDBACK_FORM" target="_blank" class="text-blue-500 hover:underline">Share feedback</a></p>
    </section>

    <!-- Add Media Form -->
    <section class="bg-white p-6 rounded-lg shadow-md mb-10 transition-transform duration-300 hover:scale-[1.02]">
      <h2 class="text-2xl font-semibold text-gray-900 mb-4">Add New Media</h2>
      <div class="flex flex-col gap-4">
        <div class="relative">
          <input
            id="title"
            type="text"
            placeholder="Enter title (e.g., The Art of the Deal)"
            aria-label="Media title"
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition-colors duration-200"
            oninput="fetchAutocomplete()"
          />
          <div id="autocomplete-loading" class="absolute right-3 top-3 hidden">
            <i class="fas fa-spinner fa-spin text-gray-400"></i>
          </div>
          <ul id="autocomplete-list" class="absolute z-20 w-full bg-white border border-gray-300 rounded-lg mt-1 max-h-48 overflow-y-auto hidden shadow-lg" role="listbox"></ul>
        </div>
        <select id="type" onchange="updateStatusOptions()" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" aria-label="Media type">
          <option value="Book">Book</option>
          <option value="Audiobook">Audiobook</option>
          <option value="TV Show">TV Show</option>
          <option value="Movie">Movie</option>
          <option value="Game">Game</option>
        </select>
        <select id="status" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" aria-label="Media status">
          <option value="To Read">To Read</option>
          <option value="Reading">Reading</option>
          <option value="Read">Read</option>
        </select>
        <button
          onclick="addMedia()"
          class="bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 transition-colors duration-200 text-lg"
        >
          Add Media
        </button>
      </div>
    </section>

    <!-- Filter Options -->
    <section class="mb-10">
      <h2 class="text-2xl font-semibold text-gray-900 mb-4">Filter</h2>
      <select
        id="filter"
        onchange="renderMedia()"
        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
        aria-label="Filter media"
      >
        <option value="All">All</option>
        <option value="Books">Books</option>
        <option value="Audiobooks">Audiobooks</option>
        <option value="TV Shows">TV Shows</option>
        <option value="Movies">Movies</option>
        <option value="Games">Games</option>
        <option value="To Read">To Read</option>
        <option value="Reading">Reading</option>
        <option value="Read">Read</option>
        <option value="To Listen">To Listen</option>
        <option value="Listening">Listening</option>
        <option value="Listened">Listened</option>
        <option value="To Watch">To Watch</option>
        <option value="Watching">Watching</option>
        <option value="Watched">Watched</option>
        <option value="To Play">To Play</option>
        <option value="Playing">Playing</option>
        <option value="Played">Played</option>
      </select>
    </section>

    <!-- Media List -->
    <section class="bg-white p-6 rounded-lg shadow-md mb-10 transition-transform duration-300 hover:scale-[1.02]">
      <h2 class="text-2xl font-semibold text-gray-900 mb-4">Your Media</h2>
      <div id="media-list" class="space-y-4"></div>
    </section>

    <!-- Affiliate Links -->
    <section id="affiliate-links" class="bg-white p-6 rounded-lg shadow-md mb-10 transition-transform duration-300 hover:scale-[1.02]">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-semibold text-gray-900">Explore More</h2>
        <button onclick="toggleAffiliateLinks()" class="text-blue-500 hover:text-blue-600 text-sm" aria-label="Toggle affiliate links">
          <i id="affiliate-toggle-icon" class="fas fa-chevron-up"></i>
        </button>
      </div>
      <div id="affiliate-content" class="space-y-2">
        <p class="text-gray-600 text-sm">Discover your next favorite media:</p>
        <div id="affiliate-list" class="flex flex-col gap-2"></div>
      </div>
    </section>

    <!-- Ad Banner -->
    <section id="ad-banner" class="text-center mb-10">
      <ins class="adsbygoogle"
           style="display:block"
           data-ad-client="ca-pub-0000000000000000"
           data-ad-slot="1234567890"
           data-ad-format="auto"
           data-full-width-responsive="true"></ins>
      <div id="ad-placeholder" class="hidden bg-gray-200 p-2 rounded-lg text-gray-600 text-sm">
        Ad loading... (Media-related ads, e.g., books, games)
      </div>
      <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-0000000000000000" crossorigin="anonymous"></script>
      <script>
        document.addEventListener('DOMContentLoaded', () => {
          try {
            (adsbygoogle = window.adsbygoogle || []).push({});
          } catch (e) {
            document.getElementById('ad-banner').innerHTML = '<p class="text-gray-500 text-sm">Ad failed to load. Please check your connection.</p>';
          }
        });
      </script>
    </section>
  </div>

  <script>
    let media = JSON.parse(localStorage.getItem('mediatracked_media')) || [];
    let isAdFree = JSON.parse(localStorage.getItem('mediatracked_isAdFree')) || false;
    let isAffiliateCollapsed = false;
    const statusOptions = {
      Book: ['To Read', 'Reading', 'Read'],
      Audiobook: ['To Listen', 'Listening', 'Listened'],
      'TV Show': ['To Watch', 'Watching', 'Watched'],
      Movie: ['To Watch', 'Watching', 'Watched'],
      Game: ['To Play', 'Playing', 'Played']
    };

    // Affiliate Links
    const affiliateLinks = {
      Book: [
        { text: 'The Art of the Deal by Donald Trump', url: 'https://bookshop.org/a/YOUR_BOOKSHOP_ID/9780399594496' },
        { text: 'Explore Books on Amazon', url: 'https://www.amazon.com/s?k=books&tag=YOUR_AMAZON_TAG' }
      ],
      Audiobook: [
        { text: 'The Art of the Deal Audiobook', url: 'https://www.audible.com/pd/The-Art-of-the-Deal-Audiobook/B01N7GKG3M?ref=YOUR_AFFILIATE_TAG' },
        { text: 'Browse Audible Audiobooks', url: 'https://www.amazon.com/Audible-Books-and-Originals/b?node=18145289011&tag=YOUR_AMAZON_TAG' }
      ],
      'TV Show': [
        { text: 'Watch Game of Thrones', url: 'https://www.amazon.com/Game-of-Thrones-Season-1/dp/B007HJ84ZK?tag=YOUR_AMAZON_TAG' },
        { text: 'Explore TV Shows on Amazon', url: 'https://www.amazon.com/s?k=tv+shows&tag=YOUR_AMAZON_TAG' }
      ],
      Movie: [
        { text: 'Dune (2021) Movie', url: 'https://www.amazon.com/Dune-Timothee-Chalamet/dp/B09M7XJH2B?tag=YOUR_AMAZON_TAG' },
        { text: 'Browse Movies on Amazon', url: 'https://www.amazon.com/s?k=movies&tag=YOUR_AMAZON_TAG' }
      ],
      Game: [
        { text: 'Cyberpunk 2077', url: 'https://www.humblebundle.com/store/cyberpunk-2077?partner=YOUR_HUMBLE_ID' },
        { text: 'Explore Games on Amazon', url: 'https://www.amazon.com/s?k=video+games&tag=YOUR_AMAZON_TAG' }
      ]
    };

    // API Keys
    const TMDB_API_KEY = 'YOUR_TMDB_API_KEY';
    const IGDB_CLIENT_ID = 'YOUR_IGDB_CLIENT_ID';
    const IGDB_TOKEN = 'YOUR_IGDB_TOKEN';

    function sanitizeInput(input) {
      const div = document.createElement('div');
      div.textContent = input;
      return div.innerHTML;
    }

    function saveMedia() {
      localStorage.setItem('mediatracked_media', JSON.stringify(media));
    }

    function updateStatusOptions() {
      const type = document.getElementById('type').value;
      const statusSelect = document.getElementById('status');
      statusSelect.innerHTML = statusOptions[type].map(status => `<option value="${status}">${status}</option>`).join('');
    }

    async function fetchAutocomplete() {
      const titleInput = sanitizeInput(document.getElementById('title').value.trim());
      const type = document.getElementById('type').value;
      const autocompleteList = document.getElementById('autocomplete-list');
      const loadingIndicator = document.getElementById('autocomplete-loading');

      if (titleInput.length < 3) {
        autocompleteList.innerHTML = '';
        autocompleteList.classList.add('hidden');
        loadingIndicator.classList.add('hidden');
        return;
      }

      loadingIndicator.classList.remove('hidden');
      autocompleteList.classList.add('hidden');

      let results = [];
      try {
        if (type === 'Book' || type === 'Audiobook') {
          const response = await fetch(`https://openlibrary.org/search.json?q=${encodeURIComponent(titleInput)}&limit=5`);
          if (!response.ok) throw new Error('Network error');
          const data = await response.json();
          results = data.docs.map(doc => ({
            title: doc.title,
            year: doc.first_publish_year || ''
          }));
        } else if (type === 'Movie' || type === 'TV Show') {
          const endpoint = type === 'Movie' ? 'movie' : 'tv';
          const response = await fetch(
            `https://api.themoviedb.org/3/search/${endpoint}?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(titleInput)}&page=1`
          );
          if (!response.ok) throw new Error('Network error');
          const data = await response.json();
          results = data.results.map(item => ({
            title: item.title || item.name,
            year: item.release_date?.split('-')[0] || item.first_air_date?.split('-')[0] || ''
          }));
        } else if (type === 'Game') {
          const response = await fetch(
            `https://api.igdb.com/v4/games`,
            {
              method: 'POST',
              headers: {
                'Client-ID': IGDB_CLIENT_ID,
                'Authorization': `Bearer ${IGDB_TOKEN}`,
                'Content-Type': 'text/plain'
              },
              body: `search "${titleInput}"; fields name,first_release_date; limit 5;`
            }
          );
          if (!response.ok) throw new Error('Network error');
          const data = await response.json();
          results = data.map(item => ({
            title: item.name,
            year: item.first_release_date ? new Date(item.first_release_date * 1000).getFullYear() : ''
          }));
        }
      } catch (error) {
        console.error('Autocomplete error:', error);
        results = [{ title: navigator.onLine ? 'Error: Check API keys' : 'Offline? Enter manually', year: '' }];
      }

      loadingIndicator.classList.add('hidden');
      autocompleteList.innerHTML = results.length && results[0].title !== 'Error: Check API keys' && results[0].title !== 'Offline? Enter manually'
        ? results.map((item, index) => `
            <li
              class="p-3 hover:bg-gray-100 cursor-pointer text-gray-800"
              role="option"
              aria-selected="false"
              onclick="selectAutocomplete('${sanitizeInput(item.title).replace(/'/g, "\\'")}')"
              onkeydown="if(event.key === 'Enter') selectAutocomplete('${sanitizeInput(item.title).replace(/'/g, "\\'")}')"
              tabindex="0"
            >
              ${sanitizeInput(item.title)} (${item.year || 'N/A'})
            </li>
          `).join('')
        : `<li class="p-3 text-gray-500">${results[0]?.title || 'No results found. Enter manually.'}</li>`;
      autocompleteList.classList.remove('hidden');
    }

    function selectAutocomplete(title) {
      document.getElementById('title').value = title;
      document.getElementById('autocomplete-list').classList.add('hidden');
    }

    function addMedia() {
      const title = sanitizeInput(document.getElementById('title').value.trim());
      const type = document.getElementById('type').value;
      const status = document.getElementById('status').value;

      if (!title) {
        alert('Please enter a title.');
        return;
      }

      const newMedia = { id: Date.now(), title, type, status };
      media.push(newMedia);
      saveMedia();
      document.getElementById('title').value = '';
      document.getElementById('autocomplete-list').classList.add('hidden');
      renderMedia();
    }

    function toggleStatus(id) {
      media = media.map(item => {
        if (item.id !== id) return item;
        const statuses = statusOptions[item.type];
        const currentIndex = statuses.indexOf(item.status);
        const nextIndex = (currentIndex + 1) % statuses.length;
        return { ...item, status: statuses[nextIndex] };
      });
      saveMedia();
      renderMedia();
    }

    function deleteMedia(id) {
      media = media.filter(item => item.id !== id);
      saveMedia();
      renderMedia();
    }

    function removeAds() {
      isAdFree = true;
      localStorage.setItem('mediatracked_isAdFree', JSON.stringify(isAdFree));
      updateAdVisibility();
      alert('Ads and affiliate links removed! (Simulated $5 purchase. Add Stripe: https://stripe.com/docs/payments)');
    }

    function toggleAffiliateLinks() {
      isAffiliateCollapsed = !isAffiliateCollapsed;
      const content = document.getElementById('affiliate-content');
      const icon = document.getElementById('affiliate-toggle-icon');
      content.classList.toggle('hidden');
      icon.classList.toggle('fa-chevron-up');
      icon.classList.toggle('fa-chevron-down');
    }

    function updateAdVisibility() {
      const adBanner = document.getElementById('ad-banner');
      const adSettings = document.getElementById('ad-settings');
      const affiliateLinks = document.getElementById('affiliate-links');
      const adPlaceholder = document.getElementById('ad-placeholder');
      if (isAdFree) {
        adBanner.style.display = 'none';
        adSettings.style.display = 'none';
        affiliateLinks.style.display = 'none';
      } else {
        adBanner.style.display = 'block';
        adSettings.style.display = 'block';
        affiliateLinks.style.display = 'block';
        adPlaceholder.classList.remove('hidden');
        setTimeout(() => adPlaceholder.classList.add('hidden'), 3000);
      }
    }

    function renderMedia() {
      const filter = document.getElementById('filter').value;
      const mediaList = document.getElementById('media-list');
      const affiliateList = document.getElementById('affiliate-list');

      const filteredMedia = media.filter(item => {
        if (filter === 'All') return true;
        if (filter === 'Books') return item.type === 'Book';
        if (filter === 'Audiobooks') return item.type === 'Audiobook';
        if (filter === 'TV Shows') return item.type === 'TV Show';
        if (filter === 'Movies') return item.type === 'Movie';
        if (filter === 'Games') return item.type === 'Game';
        return item.status === filter;
      });

      const typeIcons = {
        Book: 'fa-book',
        Audiobook: 'fa-headphones',
        'TV Show': 'fa-tv',
        Movie: 'fa-film',
        Game: 'fa-gamepad'
      };

      mediaList.innerHTML = filteredMedia.length === 0
        ? '<p class="text-gray-500 text-center py-4">Your media list is empty. Add media to start!</p>'
        : filteredMedia.map(item => `
            <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200">
              <div class="flex items-center gap-4">
                <i class="fas ${typeIcons[item.type]} text-blue-500 text-xl"></i>
                <div>
                  <h3 class="font-medium text-gray-900 text-lg">${sanitizeInput(item.title)}</h3>
                  <p class="text-sm text-gray-600">${item.type} | ${item.status}</p>
                </div>
              </div>
              <div class="flex gap-4">
                <button
                  onclick="toggleStatus(${item.id})"
                  class="text-blue-500 hover:text-blue-600 transition-colors duration-200 text-sm font-medium"
                  aria-label="Toggle status for ${sanitizeInput(item.title)}"
                >
                  Next Status
                </button>
                <button
                  onclick="deleteMedia(${item.id})"
                  class="text-red-500 hover:text-red-600 transition-colors duration-200"
                  aria-label="Delete ${sanitizeInput(item.title)}"
                >
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
          `).join('');

      const filterType = filter === 'All' || statusOptions[filter] ? (media[media.length - 1]?.type || 'Book') : filter.replace('s', '');
      const links = affiliateLinks[filterType] || affiliateLinks.Book;
      affiliateList.innerHTML = links.map(link => `
        <a href="${link.url}" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:underline text-sm">${sanitizeInput(link.text)}</a>
      `).join('');

      updateAdVisibility();
    }

    // Initialize
    updateStatusOptions();
    renderMedia();

    // Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js', { scope: '/' }).catch(error => {
          console.error('Service Worker registration failed:', error);
        });
      });
    }

    // Tailwind Config
    tailwind.config = {
      theme: {
        extend: {
          animation: {
            'fade-in': 'fadeIn 0.5s ease-out',
            'fade-in-delayed': 'fadeIn 0.5s ease-out 0.2s'
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0', transform: 'translateY(10px)' },
              '100%': { opacity: '1', transform: 'translateY(0)' }
            }
          }
        }
      }
    };
  </script>
</body>
</html>
